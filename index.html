
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;shell&quot;,&quot;ruby&quot;,&quot;python&quot;,&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">shell</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="introduction">Introduction</a>
          </li>
          <li>
            <a href="#crud" class="toc-h1 toc-link" data-title="crud">基础CRUD</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#38645019ef" class="toc-h2 toc-link" data-title="">查询文档</a>
                  </li>
                  <li>
                    <a href="#7e095e8361" class="toc-h2 toc-link" data-title="">添加文档</a>
                  </li>
                  <li>
                    <a href="#154295858c" class="toc-h2 toc-link" data-title="">批量添加文档</a>
                  </li>
                  <li>
                    <a href="#fe2cc3e076" class="toc-h2 toc-link" data-title="">更新文档</a>
                  </li>
                  <li>
                    <a href="#b6b32bb637" class="toc-h2 toc-link" data-title="">更新文档-带请求体（临时）</a>
                  </li>
                  <li>
                    <a href="#c2aea3d33b" class="toc-h2 toc-link" data-title="">删除文档类型</a>
                  </li>
                  <li>
                    <a href="#6ad63067b5" class="toc-h2 toc-link" data-title="">时间序列聚合</a>
                  </li>
                  <li>
                    <a href="#amp" class="toc-h2 toc-link" data-title="amp">文本&amp;列表字段聚合</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#78d4d8d1ca" class="toc-h1 toc-link" data-title="">查询语句示例</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#1dd7cee644" class="toc-h2 toc-link" data-title="">安全报告: 报告评分</a>
                  </li>
                  <li>
                    <a href="#5fe1951420" class="toc-h2 toc-link" data-title="">安全报告: 危险账户</a>
                  </li>
                  <li>
                    <a href="#a4bdf4f067" class="toc-h2 toc-link" data-title="">安全报告: 安全预警</a>
                  </li>
                  <li>
                    <a href="#6a68814cd4" class="toc-h2 toc-link" data-title="">安全分析: 查询接口</a>
                  </li>
                  <li>
                    <a href="#cfadd75283" class="toc-h2 toc-link" data-title="">安全日志: 日志查询</a>
                  </li>
                  <li>
                    <a href="#d06e540943" class="toc-h2 toc-link" data-title="">安全日志: 日志更新</a>
                  </li>
                  <li>
                    <a href="#ueba" class="toc-h2 toc-link" data-title="ueba">UEBA-报告页</a>
                  </li>
                  <li>
                    <a href="#ueba-2" class="toc-h2 toc-link" data-title="ueba">UEBA 用户列表页</a>
                  </li>
                  <li>
                    <a href="#ueba-3" class="toc-h2 toc-link" data-title="ueba">UEBA 用户详情页</a>
                  </li>
                  <li>
                    <a href="#ueba-4" class="toc-h2 toc-link" data-title="ueba">UEBA 安全系统架构</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#errors" class="toc-h1 toc-link" data-title="errors">Errors</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='#'>Sign Up for a Developer Key</a></li>
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>API-查询语法文档</p>

<p>This example API documentation page was created with <a href="https://github.com/lord/slate">Slate</a>. Feel free to edit it and use it as a base for your own API&#39;s documentation.</p>
<h1 id='crud'>基础CRUD</h1><h2 id='38645019ef'>查询文档</h2>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>文档列表</td>
</tr>
<tr>
<td>data.total</td>
<td>文档总数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"_external"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ignored"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"_pipeline"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"is_valid"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="mi">300</span><span class="w">
                    </span><span class="p">],</span><span class="w">
                    </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"390"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"reasoning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"caused by..."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"source_location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"杭州"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"country"</span><span class="p">:</span><span class="w"> </span><span class="s2">"中国"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="s2">"300"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"200"</span><span class="w">
                    </span><span class="p">],</span><span class="w">
                    </span><span class="s2">"time_local"</span><span class="p">:</span><span class="w"> </span><span class="mi">1528945358</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"微软云"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1528945358305.86218"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SUSPENDFAILURE"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FAILURE"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SUSPEND"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.32.100.220"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-xsy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"time_local"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-06-14T11:02:38"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_476"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_476 (HttpUrlConnection 1.8.0_102)"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">10100</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='7e095e8361'>添加文档</h2>
<p>首次添加的文档，会默认生成对应的映射表; 需要提供指定的文档ID和文档类型; </p>

<ol>
<li>文档ID是同类型中文档的唯一标志；</li>
<li>文档类型是标识一类文档的特殊关键词，在查询时也需要指定文档类型；</li>
</ol>

<p><strong>Request Url+Method:</strong> <code>POST   /api/create</code></p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>必填（非空）</td>
<td>索引ID</td>
<td>string</td>
</tr>
<tr>
<td>source</td>
<td>必填（非空）</td>
<td>待创建文档内容</td>
<td>string(json-encoded)</td>
</tr>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>待创建文档类型</td>
<td>string</td>
</tr>
</tbody></table>

<p>注意：时间戳以iso8601为标准，日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0009"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"insecure_users_by_day"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data</td>
<td>空</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='154295858c'>批量添加文档</h2>
<p>首次添加的文档，会默认生成对应的映射表; 需要提供指定的文档ID和文档类型; </p>

<p><strong>Request Url+Method:</strong> <code>POST   /api/create/bulk</code></p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td>必填（非空）</td>
<td>待创建文档列表，包含{id, source}</td>
<td>string(json-encoded)</td>
</tr>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>待创建文档类型</td>
<td>string</td>
</tr>
</tbody></table>

<p>文档列表中的每一项文档(json-encoded)，均包含id和source字段：
1. id: 是同类型中文档的唯一标志；
2. source: 原始文档(json object)；</p>

<p>注意：时间戳以iso8601为标准，日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"insecure_users_by_day"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0000"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0001"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0002"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="err">...</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0999"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.succeed</td>
<td>成功写入文档数目</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"succeed"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="w">
  </span><span class="p">},</span><span class="w"> 
  </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w"> 
  </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='fe2cc3e076'>更新文档</h2>
<p>描述：根据查询语法过滤得到一列文档，并统一更新其中的一个或多个字段</p>

<p><strong>Request Url+Method:</strong> <code>POST   /api/update</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>更新单个字段：<code>SET _pipeline.risk_level=healthy WHERE _pipeline.uid=sample_uid</code></p>

<p>更新多个字段：<code>SET _pipeline.risk_level=healthy AND _external.status=resolved WHERE _pipeline.uid=sample_uid</code></p>

<p><strong>Response Parameters:</strong> 仅解释部分有效字段</p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>查询获得文档数量</td>
</tr>
<tr>
<td>data.updated</td>
<td>更新文档数量</td>
</tr>
<tr>
<td>data.failures</td>
<td>操作异常列表</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w">
        </span><span class="s2">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>注意：如果在更新中，发生版本冲突，会自动放弃更新操作；当更新文档数量较大，或者更新操作频繁时，容易发生版本冲突；</p>
<h2 id='b6b32bb637'>更新文档-带请求体（临时）</h2>
<p>描述：根据查询语法过滤得到一列文档，并统一更新其中的一个或多个字段</p>

<p><strong>Request Url+Method:</strong> <code>POST   /api/update</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>query查询语句示例：<code>WHERE _pipeline.uid=sample_uid</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>fields</td>
<td>必填（非空）</td>
<td>待创建文档列表，包含{field, value}</td>
<td>list</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_external.feedback_risk_level"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_external.tagged_by"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_external.feedback_description"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"海外网6月25日电。蔡英文今（25日）上午出席“台湾民主基金会”创会十五周年开幕典礼。在蔡英文办公室发布的新闻稿中，竟然将台外事部门负责人吴钊燮称为“美国外交部部长”。据台湾《联合新闻网》报道，蔡英文办公室在新闻稿中指出，包括“美国外交部部长”吴钊燮、“民主基金会”执行长葛胥曼(Carl Gershman)、“台湾民主基金会”执行长徐斯俭、多位专家学者都出席了该项活动。此事一出，立即引发网友骂声一片。有网友表示，“想当美国人想疯了吗？要当部长也轮不到他啊！”还有网友直呼相关工作人员“没常识”，“美国还有外交部长吗？”还有网友称蔡办此举“是想往美国脸上贴金，十分愚蠢！”"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> 仅解释部分有效字段</p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>查询获得文档数量</td>
</tr>
<tr>
<td>data.updated</td>
<td>更新文档数量</td>
</tr>
<tr>
<td>data.failures</td>
<td>操作异常列表</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='c2aea3d33b'>删除文档类型</h2>
<p>删除指定类型的所有文档；注意这一接口仅在develop环境中允许使用；</p>

<p><strong>Request Url+Method:</strong> <code>DELETE   /api/delete/&lt;doc_type&gt;</code></p>

<p>例如：<code>curl -X DELETE http://127.0.0.1:5000/api/delete/test-0419</code></p>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data</td>
<td>空</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>如果所指定删除的类型并不存在，返回错误提示：</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cannot find index for type(s): [test_042415]"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>如果在非develop环境下调用，返回错误提示：</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"no access right to delete index:['test-0419']"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='6ad63067b5'>时间序列聚合</h2>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code></p>

<p>1&gt;. 日期以iso8601为标准，才能支持对日期的聚合查询；日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>

<p>2&gt;. 支持三种粒度的时间序列聚合：自然日、自然周（以周一为开始）、自然月，且默认为东八区时区；</p>

<table><thead>
<tr>
<th>粒度</th>
<th>描述</th>
<th>查询语句</th>
</tr>
</thead><tbody>
<tr>
<td>自然日</td>
<td>对日取整</td>
<td>GROUP BY field_name INTER day</td>
</tr>
<tr>
<td>自然周</td>
<td>对周取整，周一为开始</td>
<td>GROUP BY field_name INTER week</td>
</tr>
<tr>
<td>自然月</td>
<td>对月取整</td>
<td>GROUP BY field_name INTER month</td>
</tr>
</tbody></table>

<p>2.1&gt; 扩展：支持以自然日的倍数为粒度的时间序列聚合</p>

<table><thead>
<tr>
<th>粒度</th>
<th>描述</th>
<th>查询语句</th>
</tr>
</thead><tbody>
<tr>
<td>自然日倍数</td>
<td>对日取整</td>
<td>GROUP BY field_name INTER Nday</td>
</tr>
</tbody></table>

<p>例如：<code>GROUP BY field_name INTER 3day</code></p>

<p>3&gt;. 以时间为粒度聚合时，需严格限定起始和结束时间，否则返回报错 </p>

<p>例如： <code>WHERE field_name BETWEEN(start_time, end_time) GROUP BY field_name INTER day</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">时间序列聚合结果示例</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530547200000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530633600000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530720000000</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>时间聚合序列</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>区间内统计数</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>区间开始时间戳(毫秒单位)</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h2 id='amp'>文本&amp;列表字段聚合</h2>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>1&gt; 字段为文本类型，可以对该字段聚合：
例如：<code>GROUP BY department_1</code></p>

<p>2&gt; 字段为列表类型，列表中包含多个文本（注意不是内嵌对象），可以对该字段聚合：
例如：<code>GROUP BY departments_id</code></p>

<p>3&gt; 嵌套聚合：支持在聚合结果上再次聚合
例如：<code>GROUP BY department_1, risk_level</code>
例如：在时间序列聚合结果之上的聚合：<code>GROUP BY date INTER day, risk_level</code></p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">部门聚合结果示例</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dp-test-4-5717"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dp-test-2-2245"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dp-test-8-7506"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>部门统计列表</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>部门统计值</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>部门ID</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h1 id='78d4d8d1ca'>查询语句示例</h1><h2 id='1dd7cee644'>安全报告: 报告评分</h2>
<aside class="notice">
注意：以用户为单位的统计和查询应当以业务数据库DB为准；具体包含：
1. 用户总数
2. 危险用户数
3. 未处理危险用户数
</aside>
<h3 id='94a0aa10e3'>日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>LIMIT 0</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">日志总数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1104</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>日志总数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='a5634351d1'>危险日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE NOT _pipeline.risk_level=healthy LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='d1f6632a9c'>未处理危险日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (NOT _pipeline.risk_level=healthy) AND _external.status=unresolved LIMIT 0</code></td>
</tr>
</tbody></table>
<h2 id='5fe1951420'>安全报告: 危险账户</h2>
<aside class="notice">
注意：此处采用自定义用户表daily-risk-users；表结构和字段设计由前端决定，此处仅提供参考查询语句；
</aside>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">daily-risk-users字段结构</span><span class="w">
    </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">93</span><span class="p">,</span><span class="w">
    </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-05-12T00:05:00+00:00"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">风险等级计算时间</span><span class="w">
    </span><span class="s2">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"appSensitivity"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">应用敏感度</span><span class="w">
        </span><span class="s2">"departmentPath"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">     </span><span class="err">//</span><span class="w"> </span><span class="err">部门列表</span><span class="w">
            </span><span class="s2">"dp-test-3-3069"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"dept0"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dp-test-3-3069"</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">第一级部门</span><span class="w">
        </span><span class="s2">"positionLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">     
        </span><span class="s2">"riskLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">风险等级</span><span class="w">
        </span><span class="s2">"securityLevel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">安全等级</span><span class="w">
        </span><span class="s2">"tenantUuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">所属租户ID</span><span class="w">
        </span><span class="s2">"uuid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-200-1526460508"</span><span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">用户唯一标识UUID</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h3 id='47f07c43b2'>部门过滤器（单选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE user.dept0=dept_2jd8</code></td>
</tr>
</tbody></table>
<h3 id='8ece698b24'>时间过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE date BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)</code></td>
</tr>
</tbody></table>
<h3 id='3be26f18a7'>高危用户总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE user.riskLevel=high LIMIT 0</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">高危用户数统计值</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">183</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>日志总数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='e2913f2b72'>中危用户总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE user.riskLevel=medium LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='fc57add885'>低危用户总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE user.riskLevel=low LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='0f4f9a2074'>全部危险用户总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='3b550f1bf6'>时序图-各风险等级用户总数序列</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>daily-risk-users</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE date BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800) GROUP BY date INTER day, user.riskLevel</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1529510400000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">96</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"low"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"medium"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">282</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1529596800000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"medium"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"low"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1529683200000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1486</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果解析：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>时间序列</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>某时刻危险用户总数</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>某区间开始时间戳</td>
</tr>
<tr>
<td>data.aggs[i].buckets</td>
<td>当前时刻用户风险等级序列</td>
</tr>
<tr>
<td>data.aggs[i].buckets[j].key</td>
<td>用户风险等级</td>
</tr>
<tr>
<td>data.aggs[i].buckets[j].doc_count</td>
<td>当前时刻指定用户风险等级的用户数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h2 id='a4bdf4f067'>安全报告: 安全预警</h2><h3 id='47f07c43b2-2'>部门过滤器（单选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.department_ids=dept_2jd8</code></td>
</tr>
</tbody></table>
<h3 id='8ece698b24-2'>时间过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)</code></td>
</tr>
</tbody></table>
<h3 id='b1cd42a553'>风险等级过滤器（单选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _pipeline.risk_level=high</code></td>
</tr>
</tbody></table>

<ol>
<li>高危日志：<code>WHERE _pipeline.risk_level=high</code></li>
<li>中危日志：<code>WHERE _pipeline.risk_level=medium</code></li>
<li>低危日志：<code>WHERE _pipeline.risk_level=low</code></li>
<li>全部日志：<code>空</code></li>
</ol>
<h3 id='337acf3728'>管理员操作总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.role=admin LIMIT 0</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">管理员操作数统计值</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>日志总数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='a5634351d1-2'>危险日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE NOT _pipeline.risk_level=healthy LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='cb9baf1a29'>地址异常日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (NOT _pipeline.risk_level=healthy) AND _pipeline.risk_type=source_ip LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='5827ab6c74'>设备异常日志总数</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (NOT _pipeline.risk_level=healthy) AND _pipeline.risk_type=user_agent LIMIT 0</code></td>
</tr>
</tbody></table>
<h3 id='7b599b9484'>时序图-管理员操作数序列</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.role=admin AND (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) GROUP BY time_local INTER day</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">时序图-管理员操作数序列</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530374400000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530460800000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530547200000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530633600000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530720000000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530806400000</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1530892800000</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>时间序列</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>某时刻管理员操作数</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>某区间开始时间戳(毫秒级)</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='39068cb06b'>时序图-危险日志数序列</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (NOT _pipeline.risk_level=healthy) AND (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) GROUP BY time_local INTER day</code></td>
</tr>
</tbody></table>
<h3 id='08cecfe50b'>时序图-地址异常数序列</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800) AND _pipeline.risk_type=location GROUP BY time_local INTER day</code></td>
</tr>
</tbody></table>
<h3 id='e765c31d18'>时序图-设备异常数序列</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800) AND _pipeline.risk_type=device GROUP BY time_local INTER day</code></td>
</tr>
</tbody></table>
<h3 id='6586005139'>过滤器叠加下的聚合统计</h3>
<p>不同过滤器之间互相独立，使用AND链接
例如：</p>

<ol>
<li>部门dept_0在过去一周中风险等级为高危的地址异常日志数统计值：<code>WHERE _user.department_ids=dept_2jd8 AND _pipeline.risk_level=high AND (time_local BETWEEN(2018-06-23T00:00:00+0800, 2018-06-29T00:00:00+0800)) AND _pipeline.risk_type=location</code></li>
<li>部门dept_0在过去一周中风险等级为高危的地址异常日志数时序聚合列表：<code>WHERE _user.department_ids=dept_2jd8 AND _pipeline.risk_level=high AND (time_local BETWEEN(2018-06-23T00:00:00+0800, 2018-06-29T00:00:00+0800)) AND _pipeline.risk_type=location GROUP BY time_local INTER day</code></li>
</ol>
<h2 id='6a68814cd4'>安全分析: 查询接口</h2><h3 id='top10'>危险行为最多的用户TOP10统计图(柱状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _pipeline.uid, _pipeline.risk_level</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">危险行为最多的用户TOP</span><span class="mi">10</span><span class="err">统计图(柱状图)</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"medium"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1001</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-102-1530699833"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"medium"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-204-1530699853"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-301-1530699860"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1104</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果解析：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>用户序列</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>某用户UUID</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>某用户危险日志数</td>
</tr>
<tr>
<td>data.aggs[i].buckets</td>
<td>日志风险等级序列</td>
</tr>
<tr>
<td>data.aggs[i].buckets[j].key</td>
<td>某类日志风险等级</td>
</tr>
<tr>
<td>data.aggs[i].buckets[j].doc_count</td>
<td>某用户的指定危险等级日志数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='top10-2'>危险行为最多的用户TOP10统计图(饼状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _pipeline.risk_level, _pipeline.uid</code></td>
</tr>
</tbody></table>
<h3 id='top10-3'>危险行为最多的用户TOP10统计表</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _pipeline.uid</code></td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">危险行为最多的用户TOP</span><span class="mi">10</span><span class="err">统计表</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1001</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-102-1530699833"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-204-1530699853"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-301-1530699860"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1104</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>返回结果解析：</p>

<table><thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs</td>
<td>用户序列</td>
</tr>
<tr>
<td>data.aggs[i].key</td>
<td>某用户UUID</td>
</tr>
<tr>
<td>data.aggs[i].doc_count</td>
<td>指定用户危险日志数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='top10-4'>异常访问最多的应用TOP10统计图(柱状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY app_id, _pipeline.risk_level</code></td>
</tr>
</tbody></table>
<h3 id='top10-5'>异常访问最多的应用TOP10统计图(饼状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _pipeline.risk_level, app_id</code></td>
</tr>
</tbody></table>
<h3 id='top10-6'>异常访问最多的应用TOP10统计表</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY app_id</code></td>
</tr>
</tbody></table>
<h3 id='top10-7'>危险行为最多的部门TOP10统计图(柱状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _user.critical_department_ids, _pipeline.risk_level</code></td>
</tr>
</tbody></table>
<h3 id='top10-8'>危险行为最多的部门TOP10统计图(饼状图)</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _pipeline.risk_level, _user.critical_department_ids</code></td>
</tr>
</tbody></table>
<h3 id='top10-9'>危险行为最多的部门TOP10统计表</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE (time_local BETWEEN(2018-06-21T00:00:00+0800, 2018-06-27T00:00:00+0800)) AND (NOT _pipeline.risk_level=healthy) GROUP BY _user.critical_department_ids</code></td>
</tr>
</tbody></table>
<h2 id='cfadd75283'>安全日志: 日志查询</h2>
<p>接口调用方法见：<a href="#38645019ef">基础CRUD-查询文档</a></p>
<pre class="highlight plaintext"><code>curl -X POST \
  'http://analytic_service:5000/api/update?type=log&amp;query=WHERE%20_pipeline.risk_level%3Dhealthy%20WHERE%20event_id%3Devent-d83h'
</code></pre>
<aside class="notice">
日志查询字段列表：

1. 原始日志字段在最外层，不做解析处理；
2. 内部字段：实际存储在日志内部的字段，支持过滤和聚合；
3. 外部字段：实际存储在其他位置的字段，支持过滤和部分聚合，详见"当前支持的外部字段聚合语法"；
</aside>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="s2">"tn-yufu"</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">租户id</span><span class="w">
    </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="s2">"CREATE"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作类型</span><span class="w">
    </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="s2">"SUCCESS"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作结果</span><span class="w">
    </span><span class="s2">"time_local"</span><span class="p">:</span><span class="s2">"2018-06-11T02:17:03.355Z"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">时间</span><span class="w">
    </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="s2">"192.168.2.179"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户ip</span><span class="w">
    </span><span class="s2">"internal_ip"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">内部ip，</span><span class="w"> </span><span class="err">默认为空，</span><span class="w"> </span><span class="err">未使用</span><span class="w">
    </span><span class="s2">"uid"</span><span class="p">:</span><span class="s2">"koucunhu@yufuid.com"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">uid</span><span class="w">
    </span><span class="s2">"path"</span><span class="p">:</span><span class="s2">"/log-dir/admin-app.log"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">玉符日志</span><span class="w"> </span><span class="err">log</span><span class="w"> </span><span class="err">path</span><span class="w">
    </span><span class="s2">"host_domain"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">访问的域名，</span><span class="w"> </span><span class="err">默认为空，未使用</span><span class="w">
    </span><span class="s2">"event_id"</span><span class="p">:</span><span class="s2">"92e7f7b5-cad4-4abd-8c39-df5d360cfdd1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志唯一id</span><span class="w">
    </span><span class="s2">"_external"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"resolved_method"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">日志已处理的手段：停用(suspend)/封禁(lock)；默认为空</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志处理状态</span><span class="p">:</span><span class="w"> </span><span class="err">已处理(resolved)/未处理(unresolved)/忽略(ignored)，健康日志默认为空，危险日志默认为未处理</span><span class="w">
        </span><span class="s2">"feedback_risk_level"</span><span class="p">:</span><span class="s2">"default"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户反馈的日志危险等级，默认值为default</span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="err">取值</span><span class="p">[</span><span class="err">default</span><span class="p">,</span><span class="w"> </span><span class="err">low</span><span class="p">,</span><span class="w"> </span><span class="err">medium</span><span class="p">,</span><span class="w"> </span><span class="err">high</span><span class="p">,</span><span class="w"> </span><span class="err">healthy</span><span class="p">]</span><span class="w">
        </span><span class="s2">"feedback_description"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户输入的预警原因：可取值为长度不超过</span><span class="mi">100</span><span class="err">个汉字的字符串，初始值为缺省；用于记录用户在前端手动输入的预警原因；</span><span class="w">
        </span><span class="s2">"tagged_by"</span><span class="p">:</span><span class="s2">"system"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户标记：默认值为system</span><span class="p">,</span><span class="w"> </span><span class="err">可取值</span><span class="p">[</span><span class="err">system</span><span class="p">,</span><span class="w"> </span><span class="err">user</span><span class="p">]</span><span class="err">；用于区分每条日志展示的为系统判断结果还是用户判断结果；</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"_pipeline"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="s2">"tn-yufu"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">租户id</span><span class="w">
        </span><span class="s2">"user_agent"</span><span class="p">:{</span><span class="w">
            </span><span class="s2">"browser"</span><span class="p">:</span><span class="s2">"Chrome"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"browser_version"</span><span class="p">:</span><span class="s2">"53"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"operating_system"</span><span class="p">:</span><span class="s2">"Mac OS X"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"device"</span><span class="p">:</span><span class="s2">"Computer"</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="s2">"source_location"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户地理位置信息</span><span class="w">
            </span><span class="s2">"country"</span><span class="p">:</span><span class="s2">"中国"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"pre_device_id"</span><span class="p">:</span><span class="s2">"-1486793979"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">上一次device_id</span><span class="w">
            </span><span class="s2">"distance"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"city"</span><span class="p">:</span><span class="s2">"北京"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"latitude"</span><span class="p">:</span><span class="mf">39.54</span><span class="p">,</span><span class="w">
            </span><span class="s2">"time_local"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w">
            </span><span class="s2">"speed"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"longitude"</span><span class="p">:</span><span class="mf">116.23</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="s2">"CREATE"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作类型</span><span class="w">
        </span><span class="s2">"city_set"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">北京</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">登录地点集合</span><span class="w">
        </span><span class="s2">"operation_type_1w"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">DELETE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":12},"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":22},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">周内操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1d"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":6}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">一天内使用设备</span><span class="w">
        </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="s2">"192.168.2.179"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户ip</span><span class="w">
        </span><span class="s2">"operation_type_1h"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">小时操作汇总</span><span class="w">
        </span><span class="s2">"uid"</span><span class="p">:</span><span class="s2">"koucunhu@yufuid.com"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">uid</span><span class="w">
        </span><span class="s2">"operation_type_5m"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">5</span><span class="err">分钟操作汇总</span><span class="w">
        </span><span class="s2">"device_id_5m"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":5}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">5</span><span class="err">分钟设备汇总</span><span class="w">
        </span><span class="s2">"operation_type_1d"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">天操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1h"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":6}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">小时设备汇总</span><span class="w">
        </span><span class="s2">"ip_risk"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">ip属于黑名单的级别</span><span class="w">
        </span><span class="s2">"app_id"</span><span class="p">:</span><span class="s2">"dp-448161e21abb46478aa88a5705e93232"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作对象。</span><span class="w"> </span><span class="err">用户id或者是应用id</span><span class="w">
        </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志发生时间戳</span><span class="w">
        </span><span class="s2">"device_id"</span><span class="p">:</span><span class="s2">"-1486793979"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">设备id</span><span class="w">
        </span><span class="s2">"operation_type_4w"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">DELETE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":12},"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":22},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">4</span><span class="err">周操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1w"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">周设备汇总</span><span class="w">
        </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="s2">"SUCCESS"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作结果</span><span class="w">
        </span><span class="s2">"time_local"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志发生时间戳</span><span class="w">
        </span><span class="s2">"basic_parameter"</span><span class="p">:</span><span class="s2">"{}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">临时参数表</span><span class="w">
        </span><span class="s2">"label"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe为日志打的标签</span><span class="w">

        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"pre_location"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">country</span><span class="s2">":"</span><span class="err">中国</span><span class="s2">","</span><span class="err">pre_device_id</span><span class="s2">":"</span><span class="mi">-1486793979</span><span class="s2">","</span><span class="err">pre_time_local</span><span class="s2">":1528683423,"</span><span class="err">distance</span><span class="s2">":0,"</span><span class="err">city</span><span class="s2">":"</span><span class="err">北京</span><span class="s2">","</span><span class="err">latitude</span><span class="s2">":39.54,"</span><span class="err">time_local</span><span class="s2">":1528683423,"</span><span class="err">speed</span><span class="s2">":0,"</span><span class="err">longitude</span><span class="s2">":116.23}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户上次操作的地理位置信息</span><span class="w">
        </span><span class="s2">"labels"</span><span class="p">:[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe打的标签列表，用于日志回溯索引</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe打的tags，用于日志回溯索引</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="s2">"healthy"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe判断的日志风险等级</span><span class="p">,</span><span class="w"> </span><span class="err">取值</span><span class="p">[</span><span class="err">low</span><span class="p">,</span><span class="w"> </span><span class="err">medium</span><span class="p">,</span><span class="w"> </span><span class="err">high</span><span class="p">,</span><span class="w"> </span><span class="err">healthy</span><span class="p">]</span><span class="w">
        </span><span class="s2">"event_id"</span><span class="p">:</span><span class="s2">"92e7f7b5-cad4-4abd-8c39-df5d360cfdd1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志id</span><span class="w">
        </span><span class="s2">"operation_obj_1d"</span><span class="p">:</span><span class="s2">"{}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">天内操作对象统计</span><span class="w">
        </span><span class="s2">"is_valid"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志是否合法</span><span class="w">
        </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="s2">"None"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作描述</span><span class="w">
        </span><span class="s2">"device_id_4w"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">4</span><span class="err">周内设备统计</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">危险行为的参数，用于前端生成危险行为的描述文案</span><span class="w">

        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="s2">"None"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作描述</span><span class="w">
    </span><span class="s2">"app_id"</span><span class="p">:</span><span class="s2">"dp-448161e21abb46478aa88a5705e93232"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作对象。</span><span class="w"> </span><span class="err">用户id或者是应用id</span><span class="w">
    </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h3 id='35d2cde8fd'>内部字段（部分字段）</h3>
<p>此处仅罗列部分业务相关字段，全部字段见：<a href="https://allseeingsecurity.atlassian.net/wiki/spaces/SPC/pages/223019009">玉符全量日志字段格式</a></p>

<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>event_id</td>
<td>keyword</td>
<td>日志ID</td>
</tr>
<tr>
<td>tenant_id</td>
<td>keyword</td>
<td>租户ID</td>
</tr>
<tr>
<td>time_local</td>
<td>date</td>
<td>日志触发时间</td>
</tr>
<tr>
<td>uid</td>
<td>keyword</td>
<td>用户ID</td>
</tr>
<tr>
<td>source_ip</td>
<td>keyword</td>
<td>源IP</td>
</tr>
<tr>
<td>app_id</td>
<td>keyword</td>
<td>操作对象=应用ID或用户ID</td>
</tr>
<tr>
<td>user_agent</td>
<td>keyword</td>
<td>设备(浏览器、操作系统)</td>
</tr>
<tr>
<td>operation_type</td>
<td>keyword</td>
<td>操作类型</td>
</tr>
<tr>
<td>operation_result</td>
<td>keyword</td>
<td>操作结果</td>
</tr>
<tr>
<td>operation_description</td>
<td>text</td>
<td>操作描述</td>
</tr>
<tr>
<td>_external.status</td>
<td>keyword</td>
<td>日志处理状态</td>
</tr>
<tr>
<td>_external.resolved_method</td>
<td>keyword</td>
<td>日志已处理的手段</td>
</tr>
<tr>
<td>_external.feedback_risk_level</td>
<td>keyword</td>
<td>用户反馈日志风险等级</td>
</tr>
<tr>
<td>_external.feedback_description</td>
<td>text</td>
<td>用户输入预警原因</td>
</tr>
<tr>
<td>_external.tagged_by</td>
<td>keyword</td>
<td>用户标记</td>
</tr>
<tr>
<td>_pipeline.user_agent.browser</td>
<td>keyword</td>
<td>浏览器类型</td>
</tr>
<tr>
<td>_pipeline.source_location.city</td>
<td>keyword</td>
<td>城市</td>
</tr>
<tr>
<td>_pipeline.source_location.country</td>
<td>keyword</td>
<td>国家</td>
</tr>
<tr>
<td>_pipeline.is_valid</td>
<td>boolean</td>
<td>格式是否合法</td>
</tr>
<tr>
<td>_pipeline.risk_level</td>
<td>keyword</td>
<td>日志风险等级</td>
</tr>
<tr>
<td>_pipeline.labels</td>
<td>keyword</td>
<td>预警标签的列表（优先级由高到低）</td>
</tr>
<tr>
<td>_pipeline.label.xxx</td>
<td>float</td>
<td>某预警标签置信概率</td>
</tr>
<tr>
<td>_pipeline.tags</td>
<td>keyword</td>
<td>与某预警类型相关的列表</td>
</tr>
<tr>
<td>_pipeline.risk_type</td>
<td>keyword</td>
<td>预警类型</td>
</tr>
</tbody></table>

<p>部分核心字段补充说明：</p>

<ol>
<li>日志处理状态：已处理(resolved)/未处理(unresolved)，健康日志默认为空，危险日志默认为未处理</li>
<li>日志处理手段：停用(suspend)/封禁(lock)；默认为空</li>
<li>日志风险等级：高危(high)/中危(medium)/低危(low)/健康(healthy)，优先级高于label.xxx</li>
<li>用户反馈风险等级：默认值为default, 取值[default, low, medium, high, healthy]</li>
<li>用户标记：默认值为system, 可取值[system, user]；用于区分每条日志展示的为系统判断结果还是用户判断结果</li>
<li>预警类型：默认值为空，可取值=[location,device,account,operation,ipRisk]</li>
</ol>
<h3 id='ee984947de'>外部字段（部分字段）</h3>
<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>_user.department_ids</td>
<td>keyword</td>
<td>部门ID列表</td>
</tr>
<tr>
<td>_user.critical_department_ids</td>
<td>keyword</td>
<td>部门ID列表（用于聚合）</td>
</tr>
<tr>
<td>_user.username</td>
<td>text</td>
<td>用户名</td>
</tr>
<tr>
<td>_user.display_name</td>
<td>text</td>
<td>姓名</td>
</tr>
<tr>
<td>_user.risk_level</td>
<td>keyword</td>
<td>账户风险等级=high/mid/low/healthy</td>
</tr>
<tr>
<td>_user.role</td>
<td>keyword</td>
<td>账户角色=admin/user</td>
</tr>
</tbody></table>
<h3 id='ccc4153841'>当前支持的外部字段聚合语法</h3>
<aside class="warning">
语法不完整！待补全语法：双维度-外部和外部字段聚合；
</aside>

<ol>
<li>单维度字段聚合: <code>GROUP BY _user.critical_department_ids</code></li>
<li>双维度-内部和外部字段聚合: <code>GROUP BY _pipeline.risk_level, _user.critical_department_ids</code></li>
<li>双维度-外部和内部字段聚合: <code>GROUP BY _user.critical_department_ids, _pipeline.risk_level</code></li>
</ol>
<h3 id='674730753d'>危险、健康日志过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE  _pipeline.risk_level=healthy</code></td>
</tr>
</tbody></table>

<ol>
<li>健康日志：<code>WHERE  _pipeline.risk_level=healthy</code></li>
<li>危险日志：<code>WHERE NOT _pipeline.risk_level=healthy</code></li>
</ol>
<h3 id='de8356b743'>部门过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.department_ids=dept_2jd8</code></td>
</tr>
</tbody></table>

<ol>
<li>单个部门：<code>WHERE _user.department_ids=dept_2jd8</code></li>
<li>多个部门：<code>WHERE _user.department_ids=dept_2jd8 OR _user.department_ids=dept_9sjw</code></li>
</ol>
<h3 id='8ece698b24-3'>时间过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE time_local BETWEEN(2018-06-17T00:00:00+0800, 2018-07-01T00:00:00+0800)</code></td>
</tr>
</tbody></table>
<h3 id='49a08ee204'>用户名或姓名模糊检索过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.username~王 OR _user.display_name~王</code></td>
</tr>
</tbody></table>
<h3 id='ip'>城市或IP模糊检索过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _pipeline.source_location.city~上海 OR source_ip~上海</code></td>
</tr>
</tbody></table>
<h3 id='4d1c68dcad'>处理状态过滤器（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _external.status=unresolved</code></td>
</tr>
</tbody></table>

<ol>
<li>已处理日志：<code>WHERE _external.status=resolved</code></li>
<li>未处理日志：<code>WHERE _external.status=unresolved</code></li>
<li>多选（已处理+未处理）：<code>WHERE _external.status=resolved OR _external.status=unresolved</code> 或 <code>空</code></li>
</ol>
<h3 id='e255d01e81'>访问时间排序</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>ORDER BY time_local DESC</code></td>
</tr>
</tbody></table>

<ol>
<li>时间倒序：<code>ORDER BY time_local DESC</code></li>
<li>时间正序：<code>ORDER BY time_local ASC</code> </li>
</ol>
<h3 id='c57655e18e'>管理员过滤器（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _user.role=admin</code></td>
</tr>
</tbody></table>

<ol>
<li>管理员：<code>WHERE _user.role=admin</code></li>
<li>普通用户：<code>WHERE _user.role=user</code> </li>
<li>多选（管理员+普通用户）： <code>WHERE _user.role=admin OR _user.role=user</code> 或 <code>空</code></li>
</ol>
<h3 id='72bacb3206'>浏览器过滤器（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _pipeline.user_agent.browser=chrome</code></td>
</tr>
</tbody></table>

<ol>
<li>多选（Safari+Chrome）： <code>WHERE _pipeline.user_agent.browser=chrome OR _pipeline.user_agent.browser=safari</code></li>
</ol>
<h3 id='b266b5a278'>风险等级（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>WHERE _pipeline.risk_level=high</code></td>
</tr>
</tbody></table>

<ol>
<li>高危日志：<code>WHERE _pipeline.risk_level=high</code></li>
<li>中危日志：<code>WHERE _pipeline.risk_level=mid</code></li>
<li>低危日志：<code>WHERE _pipeline.risk_level=low</code></li>
<li>多选（高危+中危）：<code>WHERE _pipeline.risk_level=high OR _pipeline.risk_level=mid</code></li>
</ol>
<h3 id='8aa0813814'>分页器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>LIMIT 10</code></td>
</tr>
</tbody></table>

<ol>
<li>offset=0, pageSize=10：<code>LIMIT 10</code></li>
<li>offset=50, pageSize=10：<code>LIMIT 50, 10</code></li>
</ol>
<h3 id='50e7d28821'>危险日志相关日志</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>RELATED BY event_id, label</code></td>
</tr>
</tbody></table>

<p>指定危险日志event_id和危险类型标签：<code>RELATED BY event-d83h, 100</code></p>

<p>对健康日志或不存在的event_id回溯的返回结果：</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">危险日志回溯=健康日志或不存在event_id</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cannot trace back on healthy logs"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h3 id='e0457171b0'>过滤器叠加</h3>
<ol>
<li>不同过滤器的叠加由AND运算符实现；</li>
<li>当前OR运算不允许出现复合嵌套，例如（不合法实例！）：<code>WHERE (a=1 AND b=2) OR c=3</code>; </li>
<li>在以上基础上，当AND和OR同时出现，请在OR运算外部加括号表明优先级：<code>WHERE (a=1 OR b=2) AND c=3</code>;</li>
<li>BETWEEN语句在AND连用情况下，请在外部加括号表明优先级：<code>WHERE (range BETWEEN(low, high)) AND a=1</code>;</li>
</ol>

<aside class="warning">
注意：2.3.4均属于语法设计不足，07-13后版本语法树会对此做进一步优化更新；
</aside>

<p>实例：日志类型=健康 + 部门=dept_1 + 时间区间 + 用户名/姓名%王 + 时间倒序 + 第二页:pagesize=10</p>

<p><code>WHERE _pipeline.risk_level=healthy AND _user.department_ids=dept_0 AND (time_local BETWEEN(2018-06-17T00:00:00+0800, 2018-07-01T00:00:00+0800)) AND (_user.username~王 OR _user.display_name~王) ORDER BY time_local DESC LIMIT 10, 10</code></p>
<h2 id='d06e540943'>安全日志: 日志更新</h2>
<p>接口调用方法见：<a href="#fe2cc3e076">基础CRUD-更新文档</a></p>
<pre class="highlight plaintext"><code>curl -X POST \
  'http://analytic_service:5000/api/update?type=log&amp;query=WHERE%20_pipeline.risk_level%3Dhealthy%20WHERE%20event_id%3Devent-d83h'
</code></pre>
<p>日志待更新字段：</p>

<ol>
<li>内部字段：实际存储在日志内部的字段，支持更新；</li>
<li>外部字段：实际存储在其他位置的字段，不支持更新！业务数据由专用接口完成更新；</li>
</ol>

<ul>
<li>内部字段</li>
</ul>

<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>_external.status</td>
<td>keyword</td>
<td>日志处理状态=已处理(resolved)/未处理(unresolved)，健康日志默认为空，危险日志默认为未处理</td>
</tr>
<tr>
<td>_external.resolved_method</td>
<td>keyword</td>
<td>日志已处理的手段=停用(suspend)/封禁(lock)；默认为空</td>
</tr>
<tr>
<td>_pipeline.risk_level</td>
<td>keyword</td>
<td>日志风险等级=high/mid/low/healthy(优先级高于label.xxx)</td>
</tr>
</tbody></table>
<h3 id='2fd77b9f22'>日志反馈</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>SET _pipeline.risk_level=healthy WHERE event_id=event-d83h</code></td>
</tr>
</tbody></table>

<p>设置用户反馈=危险（危险程度=high）：<code>SET _pipeline.risk_level=high WHERE event_id=event-d83h</code></p>
<h3 id='1558a0e6d8'>日志处理状态设置</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td><code>SET _external.status=resolved AND _external.resolved_method=lock WHERE event_id=event-d83h</code></td>
</tr>
</tbody></table>

<ol>
<li>设置处理状态=忽略：<code>SET _external.status=ignored WHERE event_id=event-d83h</code></li>
<li>设置处理状态=已处理：<code>SET _external.status=resolved AND _external.resolved_method=lock WHERE event_id=event-d83h</code></li>
<li>设置处理状态=未处理：<code>SET _external.status=unresolved WHERE event_id=event-d83h</code></li>
</ol>

<p>注意：日志处理方法仅对处理状态=已处理时有效；</p>
<h2 id='ueba'>UEBA-报告页</h2><h3 id='92c0450e1b'>系统评分</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">系统评分</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"score"</span><span class="p">:</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w">
        </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"系统安全状况整体良好"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/systemScore</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.score</td>
<td>系统评分</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='9fe065922c'>未处理危险事件数</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">未处理危险事件数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/unresolvedInsecureEventsCount</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.count</td>
<td>未处理危险事件数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='b059aa2aaf'>危险事件数</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">危险事件数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/insecureEventsCount</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.count</td>
<td>危险事件数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='8d627465fc'>危险用户数</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">危险用户数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/insecureUsersCount</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.count</td>
<td>危险用户数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='65ad36b0cd'>总事件数</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">总事件数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">507</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/eventsCount</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.count</td>
<td>总事件数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='5e50829d28'>总用户数</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">   
    </span><span class="err">//</span><span class="w"> </span><span class="err">总用户数</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">74</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/v1/security/search/usersCount</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.count</td>
<td>总用户数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='22cb0d9de8'>系统风险趋势图</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">系统风险趋势图-请求体</span><span class="w">
    </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"start_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-15T00:00:00+08:00"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"end_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-20T00:00:00+08:00"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">系统风险趋势图-返回结果</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-16T00:00:00+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-17T00:00:00+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-18T00:00:00+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-19T00:00:00+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-20T00:00:00+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>POST   /api/v1/security/search/systemScoreTimeseries</code>  </p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户D</td>
<td>list</td>
</tr>
<tr>
<td>start_time</td>
<td>必填（非空）</td>
<td>开始时间戳ISO-8601格式</td>
<td>string</td>
</tr>
<tr>
<td>end_time</td>
<td>必填（非空）</td>
<td>结束时间戳ISO-8601格式</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>系统风险值时间序列</td>
</tr>
<tr>
<td>data.list[i].date</td>
<td>时间戳</td>
</tr>
<tr>
<td>data.list[i].risk_score</td>
<td>风险值</td>
</tr>
<tr>
<td>data.list[i].risk_score_diff</td>
<td>风险值差分</td>
</tr>
<tr>
<td>data.list[i].tenant_id</td>
<td>租户ID</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='top10-10'>风险值增长最快的账户TOP10</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">风险值增长最快的账户TOP</span><span class="mi">10</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"critical_department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"display_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"袁鸿煊"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.is_timeseries"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.timeseries_prop"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9999998807907104</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"member"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-18T17:57:32+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921624"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23@yahoo.com"</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">74</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>type: <code>user</code>
query: <code>WHERE tenant_id=tn-test-integration ORDER BY risk_score_diff DESC LIMIT 10</code></p>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>系统风险值时间序列</td>
</tr>
<tr>
<td>data.list[i].user_id</td>
<td>用户ID</td>
</tr>
<tr>
<td>data.list[i].username</td>
<td>用户名</td>
</tr>
<tr>
<td>data.list[i].display_name</td>
<td>姓名</td>
</tr>
<tr>
<td>data.list[i].risk_score</td>
<td>用户风险值</td>
</tr>
<tr>
<td>data.list[i].risk_score_diff</td>
<td>用户风险值差分</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='top10-11'>风险值最高的账户TOP10</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">风险值最高的账户TOP</span><span class="mi">10</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"critical_department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"display_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"袁鸿煊"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.is_timeseries"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.timeseries_prop"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9999998807907104</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"member"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-18T17:57:32+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921624"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23@yahoo.com"</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">74</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>type: <code>user</code>
query: <code>WHERE tenant_id=tn-test-integration ORDER BY risk_score DESC LIMIT 10</code></p>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>系统风险值时间序列</td>
</tr>
<tr>
<td>data.list[i].user_id</td>
<td>用户ID</td>
</tr>
<tr>
<td>data.list[i].username</td>
<td>用户名</td>
</tr>
<tr>
<td>data.list[i].display_name</td>
<td>姓名</td>
</tr>
<tr>
<td>data.list[i].risk_score</td>
<td>用户风险值</td>
</tr>
<tr>
<td>data.list[i].risk_score_diff</td>
<td>用户风险值差分</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h3 id='1c57383d51'>重点关注账户</h3>
<aside class="info">
注意：重点关注账户存储在业务DB中，仅风险值需要从此服务中抓取；注意此查询结果不是分页的；
</aside>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">重点关注账户-请求体</span><span class="w">
    </span><span class="s2">"users"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921624"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921658"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921572"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">重点关注账户-返回结果</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"critical_department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"default"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"display_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"袁鸿煊"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.is_timeseries"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk.timeseries_prop"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9999998807907104</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w">
                </span><span class="s2">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"member"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-18T17:57:32+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-100-1531921624"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23@yahoo.com"</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">74</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>POST   /api/users/search/bulk</code>  </p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>users</td>
<td>必填（非空）</td>
<td>用户ID列表</td>
<td>list</td>
</tr>
<tr>
<td>users[i].tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
<tr>
<td>users[i].user_id</td>
<td>必填（非空）</td>
<td>用户ID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>系统风险值时间序列</td>
</tr>
<tr>
<td>data.list[i].user_id</td>
<td>用户ID</td>
</tr>
<tr>
<td>data.list[i].username</td>
<td>用户名</td>
</tr>
<tr>
<td>data.list[i].display_name</td>
<td>姓名</td>
</tr>
<tr>
<td>data.list[i].risk_score</td>
<td>用户风险值</td>
</tr>
<tr>
<td>data.list[i].risk_score_diff</td>
<td>用户风险值差分</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h2 id='ueba-2'>UEBA 用户列表页</h2><h3 id='b3d9235f92'>用户列表</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">用户列表页</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"critical_department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"dp-test-9-795"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"department_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"dp-test-9-795"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"display_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"何展鹏"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="err">//</span><span class="w"> </span><span class="err">时间序列账户异常相关参数</span><span class="w">
                    </span><span class="s2">"timeseries"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"average"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">],</span><span class="w">
                        </span><span class="s2">"current"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="err">...</span><span class="p">],</span><span class="w">
                        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3624</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"probability"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.997</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"is_alerted"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="err">//</span><span class="w"> </span><span class="err">休眠账户异常相关参数</span><span class="w">
                    </span><span class="s2">"sleeping"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"date_range"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"is_alerted"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"risk_score_diff"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"member"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-test-integration"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-21T06:07:46+08:00"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-test-AI-8000"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3@yahoo.com"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"latest_alerted_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-21T06:07:46+08:00"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">最近告警时间</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>
<h4 id='e7f3672d7e'>按照风险值排序</h4>
<p>type: <code>user</code>
query: <code>ORDER BY risk_score_diff DESC</code></p>
<h4 id='2083bd70f5'>按照最近报警时间排序</h4>
<p>type: <code>user</code>
query: <code>ORDER BY latest_alerted_time DESC</code></p>
<h4 id='de8356b743-2'>部门过滤器</h4>
<p>type: <code>user</code>
query: <code>WHERE department_ids=dp-test-9-795</code></p>
<h4 id='bfcacdf616'>用户名或姓名模糊检索</h4>
<p>type: <code>user</code>
query: <code>WHERE username~yahoo.com OR display_name~yahoo.com</code></p>
<h4 id='bfcacdf616-2'>用户名或姓名模糊检索</h4>
<p>type: <code>user</code>
query: <code>WHERE username~yahoo.com OR display_name~yahoo.com</code></p>
<h3 id='5e4b6a9d12'>最近告警事件文案（暂缺）</h3><h2 id='ueba-3'>UEBA 用户详情页</h2><h3 id='top10-12'>常用设备列表TOP10</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">常用设备列表TOP</span><span class="mi">10</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_2) AppleWebKit/604.4.7 (KHTML, like Gecko) Version/11.0.2 Safari/604.4.7"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="err">...</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">181</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>type: <code>log</code>
query: <code>WHERE _pipeline.uid=us-test-101-1531749128 GROUP BY user_agent</code></p>
<h3 id='top10-13'>常用地址列表TOP10</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">常用地址列表TOP</span><span class="mi">10</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"东莞市"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w">
                </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"北京"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">181</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>type: <code>log</code>
query: <code>WHERE _pipeline.uid=us-test-101-1531749128 GROUP BY _pipeline.source_location.city</code></p>
<h3 id='55c26aba77'>用户信息</h3>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>type: <code>user</code>
query: <code>WHERE user_id=us-test-101-1531749128</code></p>
<h3 id='5e4b6a9d12-2'>最近告警事件文案（暂缺）</h3><h3 id='dea8862146'>事件列表</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">事件列表</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant-3jd9"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"location_1"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"event_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"log"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">事件类型</span><span class="w">
                </span><span class="s2">"risk_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">   </span><span class="err">//</span><span class="w"> </span><span class="err">事件风险值</span><span class="w">    
                </span><span class="s2">"security_event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d7fee2e1-b371-43d8-b34f-903789065457"</span><span class="p">,</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">事件ID</span><span class="w">
                </span><span class="s2">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"related_events"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="s2">"100-1518537602058"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">关联日志ID列表</span><span class="w">
                    </span><span class="p">]</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1522648800</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日期格式，单位=秒</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>GET   /api/search</code>  </p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>
<h4 id='730796fe92'>按照触发时间排序</h4>
<p>type: <code>event</code>
query: <code>ORDER BY timestamp DESC</code></p>
<h4 id='e7f3672d7e-2'>按照风险值排序</h4>
<p>type: <code>event</code>
query: <code>ORDER BY risk_score DESC</code></p>
<h3 id='e05827bf8c'>事件描述信息(暂缺)</h3><h2 id='ueba-4'>UEBA 安全系统架构</h2><h3 id='a4195a9393'>系统+用户风险值更新计算</h3><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">风险值更新计算-请求体</span><span class="w">
    </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tenant-s8k3"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">租户ID</span><span class="w">
    </span><span class="s2">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-d93k"</span><span class="p">,</span><span class="w">     </span><span class="err">//</span><span class="w"> </span><span class="err">用户UUID</span><span class="w">
    </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-07-19T20:29:00+08:00"</span><span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="err">触发异常时间</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">风险值更新计算-返回结果</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">    
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">       
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">  
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Request Url+Method:</strong> <code>POST  /api/v1/security/update/calculateRiskScore</code>  </p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>timestamp</td>
<td>必填（非空）</td>
<td>触发异常时间</td>
<td>string</td>
</tr>
<tr>
<td>tenant_id</td>
<td>必填（非空）</td>
<td>租户ID</td>
<td>string</td>
</tr>
<tr>
<td>user_id</td>
<td>必填（非空）</td>
<td>用户UUID</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data</td>
<td>空</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<h1 id='errors'>Errors</h1>
<aside class="notice">
This error section is stored in a separate file in <code>includes/_errors.md</code>. Slate allows you to optionally separate out your docs into many files...just save them to the <code>includes</code> folder and add them to the top of your <code>index.md</code>'s frontmatter. Files are included in the order listed.
</aside>

<p>The Kittn API uses the following error codes:</p>

<table><thead>
<tr>
<th>Error Code</th>
<th>Meaning</th>
</tr>
</thead><tbody>
<tr>
<td>400</td>
<td>Bad Request -- Your request is invalid.</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized -- Your API key is wrong.</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden -- The kitten requested is hidden for administrators only.</td>
</tr>
<tr>
<td>404</td>
<td>Not Found -- The specified kitten could not be found.</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed -- You tried to access a kitten with an invalid method.</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable -- You requested a format that isn&#39;t json.</td>
</tr>
<tr>
<td>410</td>
<td>Gone -- The kitten requested has been removed from our servers.</td>
</tr>
<tr>
<td>418</td>
<td>I&#39;m a teapot.</td>
</tr>
<tr>
<td>429</td>
<td>Too Many Requests -- You&#39;re requesting too many kittens! Slow down!</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error -- We had a problem with our server. Try again later.</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable -- We&#39;re temporarily offline for maintenance. Please try again later.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">shell</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
