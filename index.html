
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;shell&quot;,&quot;ruby&quot;,&quot;python&quot;,&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">shell</a>
              <a href="#" data-language-name="ruby">ruby</a>
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="introduction">Introduction</a>
          </li>
          <li>
            <a href="#crud" class="toc-h1 toc-link" data-title="crud">基础CRUD</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#38645019ef" class="toc-h2 toc-link" data-title="">查询文档</a>
                  </li>
                  <li>
                    <a href="#7e095e8361" class="toc-h2 toc-link" data-title="">添加文档</a>
                  </li>
                  <li>
                    <a href="#154295858c" class="toc-h2 toc-link" data-title="">批量添加文档</a>
                  </li>
                  <li>
                    <a href="#fe2cc3e076" class="toc-h2 toc-link" data-title="">更新文档</a>
                  </li>
                  <li>
                    <a href="#c2aea3d33b" class="toc-h2 toc-link" data-title="">删除文档类型</a>
                  </li>
                  <li>
                    <a href="#6ad63067b5" class="toc-h2 toc-link" data-title="">时间序列聚合</a>
                  </li>
                  <li>
                    <a href="#amp" class="toc-h2 toc-link" data-title="amp">文本&amp;列表字段聚合</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#78d4d8d1ca" class="toc-h1 toc-link" data-title="">查询语句示例</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#e7d73a53d9" class="toc-h2 toc-link" data-title="">安全日志：查询接口</a>
                  </li>
                  <li>
                    <a href="#9ae4129295" class="toc-h2 toc-link" data-title="">安全日志：更新接口</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#errors" class="toc-h1 toc-link" data-title="errors">Errors</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='#'>Sign Up for a Developer Key</a></li>
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>API-查询语法文档</p>

<p>This example API documentation page was created with <a href="https://github.com/lord/slate">Slate</a>. Feel free to edit it and use it as a base for your own API&#39;s documentation.</p>
<h1 id='crud'>基础CRUD</h1><h2 id='38645019ef'>查询文档</h2>
<p><strong>HTTP Reqeust:</strong> <code>GET   /api/search</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.list</td>
<td>文档列表</td>
</tr>
<tr>
<td>data.total</td>
<td>文档总数</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"_external"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ignored"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"_pipeline"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"is_valid"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="mi">300</span><span class="w">
                    </span><span class="p">],</span><span class="w">
                    </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"390"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"reasoning"</span><span class="p">:</span><span class="w"> </span><span class="s2">"caused by..."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"high"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"source_location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"杭州"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"country"</span><span class="p">:</span><span class="w"> </span><span class="s2">"中国"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                        </span><span class="s2">"300"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"200"</span><span class="w">
                    </span><span class="p">],</span><span class="w">
                    </span><span class="s2">"time_local"</span><span class="p">:</span><span class="w"> </span><span class="mi">1528945358</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"微软云"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1528945358305.86218"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SUSPENDFAILURE"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FAILURE"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SUSPEND"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.32.100.220"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tn-xsy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"time_local"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-06-14T11:02:38"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_476"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_476 (HttpUrlConnection 1.8.0_102)"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">10100</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='7e095e8361'>添加文档</h2>
<p>首次添加的文档，会默认生成对应的映射表; 需要提供指定的文档ID和文档类型; </p>

<ol>
<li>文档ID是同类型中文档的唯一标志；</li>
<li>文档类型是标识一类文档的特殊关键词，在查询时也需要指定文档类型；</li>
</ol>

<p><strong>HTTP Reqeust:</strong> <code>POST   /api/create</code></p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>必填（非空）</td>
<td>索引ID</td>
<td>string</td>
</tr>
<tr>
<td>source</td>
<td>必填（非空）</td>
<td>待创建文档内容</td>
<td>string(json-encoded)</td>
</tr>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>待创建文档类型</td>
<td>string</td>
</tr>
</tbody></table>

<p>注意：时间戳以iso8601为标准，日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0009"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"insecure_users_by_day"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data</td>
<td>空</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='154295858c'>批量添加文档</h2>
<p>首次添加的文档，会默认生成对应的映射表; 需要提供指定的文档ID和文档类型; </p>

<p><strong>HTTP Reqeust:</strong> <code>POST   /api/create/bulk</code></p>

<p><strong>Request Headers:</strong></p>

<table><thead>
<tr>
<th>Header</th>
<th>Value</th>
</tr>
</thead><tbody>
<tr>
<td>Content-Type</td>
<td>application/json</td>
</tr>
</tbody></table>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td>必填（非空）</td>
<td>待创建文档列表，包含{id, source}</td>
<td>string(json-encoded)</td>
</tr>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>待创建文档类型</td>
<td>string</td>
</tr>
</tbody></table>

<p>文档列表中的每一项文档(json-encoded)，均包含id和source字段：
1. id: 是同类型中文档的唯一标志；
2. source: 原始文档(json object)；</p>

<p>注意：时间戳以iso8601为标准，日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"insecure_users_by_day"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0000"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0001"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0002"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">},</span><span class="w">
        </span><span class="err">...</span><span class="w">
        </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"0999"</span><span class="p">,</span><span class="s2">"source"</span><span class="p">:</span><span class="s2">"{ </span><span class="se">\"</span><span class="s2">date</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">2018-04-22T22:16:00+0800</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">user_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">user_123</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">departments_id</span><span class="se">\"</span><span class="s2">: [</span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">], </span><span class="se">\"</span><span class="s2">department_1</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">dept_2</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">security_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">high</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">risk_level</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">mid</span><span class="se">\"</span><span class="s2">}"</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.succeed</td>
<td>成功写入文档数目</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"succeed"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="w">
  </span><span class="p">},</span><span class="w"> 
  </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w"> 
  </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='fe2cc3e076'>更新文档</h2>
<p>描述：根据查询语法过滤得到一列文档，并统一更新其中的一个或多个字段</p>

<p><strong>HTTP Reqeust:</strong> <code>POST   /api/update</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>更新单个字段：<code>SET _pipeline.risk_level=healthy WHERE uid=sample_uid</code></p>

<p>更新多个字段：<code>SET _pipeline.risk_level=healthy AND _external.status=resolved WHERE uid=sample_uid</code></p>

<p><strong>Response Parameters:</strong> 仅解释部分有效字段</p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.total</td>
<td>查询获得文档数量</td>
</tr>
<tr>
<td>data.updated</td>
<td>更新文档数量</td>
</tr>
<tr>
<td>data.failures</td>
<td>操作异常列表</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"failures"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w">
        </span><span class="s2">"updated"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>注意：如果在更新中，发生版本冲突，会自动放弃更新操作；当更新文档数量较大，或者更新操作频繁时，容易发生版本冲突；</p>
<pre class="highlight json tab-json"><code><span class="w">
</span></code></pre><h2 id='c2aea3d33b'>删除文档类型</h2>
<p>删除指定类型的所有文档；注意这一接口仅在develop环境中允许使用；</p>

<p><strong>HTTP Reqeust:</strong> <code>DELETE   /api/delete/&lt;doc_type&gt;</code></p>

<p>例如：<code>curl -X DELETE http://127.0.0.1:5000/api/delete/test-0419</code></p>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data</td>
<td>空</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>如果所指定删除的类型并不存在，返回错误提示：</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"deleted"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cannot find index for type(s): [test_042415]"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>如果在非develop环境下调用，返回错误提示：</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"no access right to delete index:['test-0419']"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h2 id='6ad63067b5'>时间序列聚合</h2>
<p><strong>HTTP Reqeust:</strong> <code>GET   /api/search</code></p>

<p>1&gt;. 日期以iso8601为标准，才能支持对日期的聚合查询；日期中必须携带时区信息，例如：2018-04-22T22:16:00+0800</p>

<p>2&gt;. 支持三种粒度的时间序列聚合：自然日、自然周（以周一为开始）、自然月，且默认为东八区时区；</p>

<table><thead>
<tr>
<th>粒度</th>
<th>描述</th>
<th>查询语句</th>
</tr>
</thead><tbody>
<tr>
<td>自然日</td>
<td>对日取整</td>
<td>GROUP BY field_name INTER day</td>
</tr>
<tr>
<td>自然周</td>
<td>对周取整，周一为开始</td>
<td>GROUP BY field_name INTER week</td>
</tr>
<tr>
<td>自然月</td>
<td>对月取整</td>
<td>GROUP BY field_name INTER month</td>
</tr>
</tbody></table>

<p>2.1&gt; 扩展：支持以自然日的倍数为粒度的时间序列聚合</p>

<table><thead>
<tr>
<th>粒度</th>
<th>描述</th>
<th>查询语句</th>
</tr>
</thead><tbody>
<tr>
<td>自然日倍数</td>
<td>对日取整</td>
<td>GROUP BY field_name INTER Nday</td>
</tr>
</tbody></table>

<p>例如：<code>GROUP BY field_name INTER 3day</code></p>

<p>3&gt;. 以时间为粒度聚合时，需严格限定起始和结束时间，否则返回报错 </p>

<p>例如： <code>WHERE field_name BETWEEN(start_time, end_time) GROUP BY field_name INTER day</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs.dimension_a.buckets</td>
<td>时间聚合序列</td>
</tr>
<tr>
<td>data.aggs.dimension_a.buckets[i].doc_count</td>
<td>区间内统计数</td>
</tr>
<tr>
<td>data.aggs.dimension_a.buckets[i].key</td>
<td>区间开始时间戳(毫秒单位)</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"dimension_a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1523203200000</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-04-09T00:00:00.000+08:00"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1524067200000</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-04-19T00:00:00.000+08:00"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="mi">1524931200000</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key_as_string"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-04-29T00:00:00.000+08:00"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h3 id='b0ceb2263c'>实例：部门过滤器+安全等级+风险等级+时间聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE department_id=dept_3 AND security_level=high AND risk_level=high AND (date BETWEEN(2018-04-17T17:00:00+0800, 2018-05-01T00:00:00+0800)) GROUP BY date INTER day</td>
</tr>
</tbody></table>

<p>注意：如果使用嵌套聚合，则将risk_level放在GROUP BY语句中</p>

<p>例如：<code>WHERE department_id=dept_3 AND security_level=high AND (date BETWEEN(2018-04-17T17:00:00+0800, 2018-05-01T00:00:00+0800)) GROUP BY date INTER day, risk_level</code></p>
<h2 id='amp'>文本&amp;列表字段聚合</h2>
<p><strong>HTTP Reqeust:</strong> <code>GET   /api/search</code></p>

<p><strong>Request Parameters:</strong></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
<th>Type</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>必填（非空）</td>
<td>查询文档类型</td>
<td>string</td>
</tr>
<tr>
<td>query</td>
<td>必填（非空）</td>
<td>查询语句</td>
<td>string</td>
</tr>
</tbody></table>

<p>1&gt; 字段为文本类型，可以对该字段聚合：
例如：<code>GROUP BY department_1</code></p>

<p>2&gt; 字段为列表类型，列表中包含多个文本（注意不是内嵌对象），可以对该字段聚合：
例如：<code>GROUP BY departments_id</code></p>

<p>3&gt; 嵌套聚合：支持在聚合结果上再次聚合
例如：<code>GROUP BY department_1, risk_level</code>
例如：在时间序列聚合结果之上的聚合：<code>GROUP BY date INTER day, risk_level</code></p>

<p><strong>Response Parameters:</strong> </p>

<table><thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead><tbody>
<tr>
<td>data.aggs.dimension_a.buckets</td>
<td>部门统计列表</td>
</tr>
<tr>
<td>data.aggs.dimension_a.buckets[i].doc_count</td>
<td>部门统计值</td>
</tr>
<tr>
<td>data.aggs.dimension_a.buckets[i].key</td>
<td>部门ID</td>
</tr>
<tr>
<td>message</td>
<td>返回状态描述</td>
</tr>
<tr>
<td>status</td>
<td>返回状态码</td>
</tr>
</tbody></table>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"dimension_a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"buckets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_6"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_7"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_1"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_9"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_8"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_3"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_5"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_2"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_4"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dept_0"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"doc_count_error_upper_bound"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                </span><span class="s2">"sum_other_doc_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"list"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"success"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre><h3 id='84058c10ac'>实例：部门列表聚合</h3>
<p>注意：
1. departments_id是列表，例如 [&#39;id_1&#39;, &#39;id_2&#39;, ...]；列表中元素类型应当保持一致；元素类型不能是对象；
2. BETWEEN语句作为过滤器，出现在AND语句中时，建议使用括号区分优先级；例如 <code>condition A AND ( condition B with BETWENN )</code></p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800) GROUP BY departments_id</td>
</tr>
</tbody></table>
<h3 id='aadee20761'>实例：部门过滤器+风险评级聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE deparment_id=dept_3 AND (date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800)) GROUP BY risk_level</td>
</tr>
</tbody></table>
<h3 id='aadee20761-2'>实例：部门过滤器+风险评级聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE deparment_id=dept_3 AND (date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800)) GROUP BY risk_level</td>
</tr>
</tbody></table>
<h3 id='93a87898f0'>实例：用户聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800) GROUP BY user_id</td>
</tr>
</tbody></table>
<h3 id='551f7b46ca'>实例：用户过滤器+风险评级聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE user_id=user_1 AND (date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800)) GROUP BY risk_level</td>
</tr>
</tbody></table>
<h3 id='64f6187dc3'>实例：风险过滤器+应用聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE risk_level=high AND (date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800)) GROUP BY app_id</td>
</tr>
</tbody></table>
<h3 id='b2151e7ee4'>实例：风险过滤器+（第一层级）部门聚合</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>insecure_users_by_day</td>
</tr>
<tr>
<td>query</td>
<td>WHERE risk_level=high AND (date BETWEEN(2018-04-17T17:00:00-0800, 2018-05-01T00:00:00-0800)) GROUP BY department_1</td>
</tr>
</tbody></table>
<h1 id='78d4d8d1ca'>查询语句示例</h1><h2 id='e7d73a53d9'>安全日志：查询接口</h2>
<p>接口调用方法见：<a href="#38645019ef">基础CRUD-查询文档</a></p>
<pre class="highlight plaintext"><code>curl -X POST \
  'http://analytic_service:5000/api/update?type=log&amp;query=WHERE%20_pipeline.risk_level%3Dhealthy%20WHERE%20event_id%3Devent-d83h'
</code></pre>
<p>日志查询字段列表：</p>

<ol>
<li>原始日志字段在最外层，不做解析处理；</li>
<li>内部字段：实际存储在日志内部的字段，支持过滤和聚合；</li>
<li>外部字段：实际存储在其他位置的字段，目前仅支持过滤，在06-25之后版本考虑实现聚合；</li>
</ol>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="s2">"tn-yufu"</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">租户id</span><span class="w">
    </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="s2">"CREATE"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作类型</span><span class="w">
    </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="s2">"SUCCESS"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作结果</span><span class="w">
    </span><span class="s2">"time_local"</span><span class="p">:</span><span class="s2">"2018-06-11T02:17:03.355Z"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">时间</span><span class="w">
    </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="s2">"192.168.2.179"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户ip</span><span class="w">
    </span><span class="s2">"internal_ip"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">内部ip，</span><span class="w"> </span><span class="err">默认为空，</span><span class="w"> </span><span class="err">未使用</span><span class="w">
    </span><span class="s2">"uid"</span><span class="p">:</span><span class="s2">"koucunhu@yufuid.com"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">uid</span><span class="w">
    </span><span class="s2">"path"</span><span class="p">:</span><span class="s2">"/log-dir/admin-app.log"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">玉符日志</span><span class="w"> </span><span class="err">log</span><span class="w"> </span><span class="err">path</span><span class="w">
    </span><span class="s2">"host_domain"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">访问的域名，</span><span class="w"> </span><span class="err">默认为空，未使用</span><span class="w">
    </span><span class="s2">"event_id"</span><span class="p">:</span><span class="s2">"92e7f7b5-cad4-4abd-8c39-df5d360cfdd1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志唯一id</span><span class="w">
    </span><span class="s2">"_external"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"resolved_method"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">日志已处理的手段：停用(suspend)/封禁(lock)；默认为空</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="s2">""</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志处理状态</span><span class="p">:</span><span class="w"> </span><span class="err">已处理(resolved)/未处理(unresolved)/忽略(ignored)，健康日志默认为空，危险日志默认为未处理</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"_pipeline"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"tenant_id"</span><span class="p">:</span><span class="s2">"tn-yufu"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">租户id</span><span class="w">
        </span><span class="s2">"source_location"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户地理位置信息</span><span class="w">
            </span><span class="s2">"country"</span><span class="p">:</span><span class="s2">"中国"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"pre_device_id"</span><span class="p">:</span><span class="s2">"-1486793979"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">上一次device_id</span><span class="w">
            </span><span class="s2">"distance"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"city"</span><span class="p">:</span><span class="s2">"北京"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"latitude"</span><span class="p">:</span><span class="mf">39.54</span><span class="p">,</span><span class="w">
            </span><span class="s2">"time_local"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w">
            </span><span class="s2">"speed"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"longitude"</span><span class="p">:</span><span class="mf">116.23</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"operation_type"</span><span class="p">:</span><span class="s2">"CREATE"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作类型</span><span class="w">
        </span><span class="s2">"city_set"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">北京</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">登录地点集合</span><span class="w">
        </span><span class="s2">"operation_type_1w"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">DELETE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":12},"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":22},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">周内操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1d"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":6}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">一天内使用设备</span><span class="w">
        </span><span class="s2">"feedback_risk_level"</span><span class="p">:</span><span class="s2">"healthy"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户反馈的日志危险等级，默认值等同于risk_level的值</span><span class="w">
        </span><span class="s2">"source_ip"</span><span class="p">:</span><span class="s2">"192.168.2.179"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户ip</span><span class="w">
        </span><span class="s2">"operation_type_1h"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">小时操作汇总</span><span class="w">
        </span><span class="s2">"uid"</span><span class="p">:</span><span class="s2">"koucunhu@yufuid.com"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">uid</span><span class="w">
        </span><span class="s2">"operation_type_5m"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">5</span><span class="err">分钟操作汇总</span><span class="w">
        </span><span class="s2">"device_id_5m"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":5}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">5</span><span class="err">分钟设备汇总</span><span class="w">
        </span><span class="s2">"operation_type_1d"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":5},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">天操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1h"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":6}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">小时设备汇总</span><span class="w">
        </span><span class="s2">"ip_risk"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">ip属于黑名单的级别</span><span class="w">
        </span><span class="s2">"app_id"</span><span class="p">:</span><span class="s2">"dp-448161e21abb46478aa88a5705e93232"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作对象。</span><span class="w"> </span><span class="err">用户id或者是应用id</span><span class="w">
        </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志发生时间戳</span><span class="w">
        </span><span class="s2">"device_id"</span><span class="p">:</span><span class="s2">"-1486793979"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">设备id</span><span class="w">
        </span><span class="s2">"operation_type_4w"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">DELETE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":12},"</span><span class="err">CREATE</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":22},"</span><span class="err">LOGIN</span><span class="s2">":{"</span><span class="err">SUCCESS</span><span class="s2">":1}}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">4</span><span class="err">周操作汇总</span><span class="w">
        </span><span class="s2">"device_id_1w"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">周设备汇总</span><span class="w">
        </span><span class="s2">"operation_result"</span><span class="p">:</span><span class="s2">"SUCCESS"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作结果</span><span class="w">
        </span><span class="s2">"time_local"</span><span class="p">:</span><span class="mi">1528683423</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志发生时间戳</span><span class="w">
        </span><span class="s2">"basic_parameter"</span><span class="p">:</span><span class="s2">"{}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">临时参数表</span><span class="w">
        </span><span class="s2">"label"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe为日志打的标签</span><span class="w">

        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"pre_location"</span><span class="p">:</span><span class="s2">"{"</span><span class="err">country</span><span class="s2">":"</span><span class="err">中国</span><span class="s2">","</span><span class="err">pre_device_id</span><span class="s2">":"</span><span class="mi">-1486793979</span><span class="s2">","</span><span class="err">pre_time_local</span><span class="s2">":1528683423,"</span><span class="err">distance</span><span class="s2">":0,"</span><span class="err">city</span><span class="s2">":"</span><span class="err">北京</span><span class="s2">","</span><span class="err">latitude</span><span class="s2">":39.54,"</span><span class="err">time_local</span><span class="s2">":1528683423,"</span><span class="err">speed</span><span class="s2">":0,"</span><span class="err">longitude</span><span class="s2">":116.23}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">用户上次操作的地理位置信息</span><span class="w">
        </span><span class="s2">"labels"</span><span class="p">:[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe打的标签列表，用于日志回溯索引</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe打的tags，用于日志回溯索引</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"risk_level"</span><span class="p">:</span><span class="s2">"healthy"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">data-pipe判断的日志风险等级</span><span class="w">
        </span><span class="s2">"event_id"</span><span class="p">:</span><span class="s2">"92e7f7b5-cad4-4abd-8c39-df5d360cfdd1"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志id</span><span class="w">
        </span><span class="s2">"operation_obj_1d"</span><span class="p">:</span><span class="s2">"{}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">1</span><span class="err">天内操作对象统计</span><span class="w">
        </span><span class="s2">"is_valid"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">日志是否合法</span><span class="w">
        </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="s2">"None"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作描述</span><span class="w">
        </span><span class="s2">"device_id_4w"</span><span class="p">:</span><span class="s2">"{"</span><span class="mi">-1486793979</span><span class="s2">":35}"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">4</span><span class="err">周内设备统计</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">危险行为的参数，用于前端生成危险行为的描述文案</span><span class="w">

        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"operation_description"</span><span class="p">:</span><span class="s2">"None"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作描述</span><span class="w">
    </span><span class="s2">"app_id"</span><span class="p">:</span><span class="s2">"dp-448161e21abb46478aa88a5705e93232"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">操作对象。</span><span class="w"> </span><span class="err">用户id或者是应用id</span><span class="w">
    </span><span class="s2">"user_agent"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<ul>
<li>内部字段</li>
</ul>

<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>event_id</td>
<td>keyword</td>
<td>日志ID</td>
</tr>
<tr>
<td>tenant_id</td>
<td>keyword</td>
<td>租户ID</td>
</tr>
<tr>
<td>time_local</td>
<td>date</td>
<td>日志触发时间</td>
</tr>
<tr>
<td>uid</td>
<td>keyword</td>
<td>用户ID</td>
</tr>
<tr>
<td>source_ip</td>
<td>keyword</td>
<td>源IP</td>
</tr>
<tr>
<td>app_id</td>
<td>keyword</td>
<td>操作对象=应用ID或用户ID</td>
</tr>
<tr>
<td>user_agent</td>
<td>keyword</td>
<td>设备(浏览器、操作系统)</td>
</tr>
<tr>
<td>operation_type</td>
<td>keyword</td>
<td>操作类型</td>
</tr>
<tr>
<td>operation_result</td>
<td>keyword</td>
<td>操作结果</td>
</tr>
<tr>
<td>operation_description</td>
<td>text</td>
<td>操作描述（考虑分词）</td>
</tr>
<tr>
<td>_external.status</td>
<td>keyword</td>
<td>日志处理状态=已处理(resolved)/未处理(unresolved)/忽略(ignored)</td>
</tr>
</tbody></table>

<p>，健康日志默认为空，危险日志默认为未处理
_external.resolved_method   | keyword   |   日志已处理的手段=停用(suspend)/封禁(lock)；默认为空
_pipeline.source_location.city |     keyword     |     城市
_pipeline.source_location.country |     keyword     |     国家
_pipeline.is_valid    |     boolean     |     格式是否合法<br>
_pipeline.risk_level    |     keyword     |     日志风险等级=high/mid/low/healthy(优先级高于label.xxx)
_pipeline.labels    |     keyword     |     预警类型的列表（优先级由高到低）
_pipeline.label.xxx   |     float     |     某预警类型置信概率
_pipeline.tags|      keyword     |    与某预警类型相关的列表</p>

<ul>
<li>外部字段</li>
</ul>

<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>_user.department_ids</td>
<td>keyword</td>
<td>部门ID列表</td>
</tr>
<tr>
<td>_user.critical_department_ids</td>
<td>keyword</td>
<td>部门ID列表（用于聚合）</td>
</tr>
<tr>
<td>_user.username</td>
<td>text</td>
<td>用户名</td>
</tr>
<tr>
<td>_user.display_name</td>
<td>text</td>
<td>姓名</td>
</tr>
<tr>
<td>_user.risk_level</td>
<td>keyword</td>
<td>账户风险等级=high/mid/low/healthy</td>
</tr>
<tr>
<td>_user.role</td>
<td>keyword</td>
<td>账户角色=admin/user</td>
</tr>
</tbody></table>
<h3 id='d3fa086ed2'>日志合法过滤器：</h3>
<p>注意任何查询中都需要添加公共过滤器：日志格式合法标志位；</p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE  _pipeline.is_valid=true</td>
</tr>
</tbody></table>

<ol>
<li>格式合法日志：<code>WHERE  _pipeline.is_valid=true</code></li>
<li>格式非法日志：<code>WHERE  _pipeline.is_valid=false</code></li>
</ol>
<h3 id='674730753d'>危险、健康日志过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE  _pipeline.risk_level=healthy</td>
</tr>
</tbody></table>

<ol>
<li>健康日志：<code>WHERE  _pipeline.risk_level=healthy</code></li>
<li>危险日志：<code>WHERE NOT _pipeline.risk_level=healthy</code></li>
</ol>
<h3 id='de8356b743'>部门过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _user.department_ids=dept_2jd8</td>
</tr>
</tbody></table>

<ol>
<li>单个部门：<code>WHERE _user.department_ids=dept_2jd8</code></li>
<li>多个部门：<code>WHERE _user.department_ids=dept_2jd8 OR _user.department_ids=dept_9sjw</code></li>
</ol>
<h3 id='8ece698b24'>时间过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE time_local BETWEEN(2018-06-17T00:00:00+0800, 2018-07-01T00:00:00+0800)</td>
</tr>
</tbody></table>
<h3 id='49a08ee204'>用户名或姓名模糊检索过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _user.username~王 OR _user.display_name~王</td>
</tr>
</tbody></table>
<h3 id='ip'>城市或IP模糊检索过滤器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _pipeline.source_location.city~上海 OR source_ip~上海</td>
</tr>
</tbody></table>
<h3 id='4d1c68dcad'>处理状态过滤器（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _external.status=unresolved</td>
</tr>
</tbody></table>

<ol>
<li>已处理日志：<code>WHERE _external.status=resolved</code></li>
<li>未处理日志：<code>WHERE _external.status=unresolved</code></li>
<li>已忽略日志：<code>WHERE _external.status=ignored</code></li>
<li>多选（已处理+已忽略）：<code>WHERE _external.status=resolved OR _external.status=ignored</code></li>
</ol>
<h3 id='e255d01e81'>访问时间排序</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>ORDER BY time_local DESC</td>
</tr>
</tbody></table>

<ol>
<li>时间倒序：<code>ORDER BY time_local DESC</code></li>
<li>时间正序：<code>ORDER BY time_local ASC</code> </li>
</ol>
<h3 id='c57655e18e'>管理员过滤器（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _user.role=admin</td>
</tr>
</tbody></table>

<ol>
<li>管理员：<code>WHERE _user.role=admin</code></li>
<li>普通用户：<code>WHERE _user.role=user</code> </li>
<li>多选（管理员+普通用户）： <code>WHERE _user.role=admin OR _user.role=user</code> 或 <code>空</code></li>
</ol>
<h3 id='pipeline'>浏览器过滤器（可多选）?? pipeline是否有全解析字段</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE user_agent~Chrome</td>
</tr>
</tbody></table>

<ol>
<li>多选（Safari+Chrome）： <code>WHERE user_agent~Chrome OR user_agent~Safari</code></li>
</ol>
<h3 id='b266b5a278'>风险等级（可多选）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>WHERE _pipeline.risk_level=high</td>
</tr>
</tbody></table>

<ol>
<li>高危日志：<code>WHERE _pipeline.risk_level=high</code></li>
<li>中危日志：<code>WHERE _pipeline.risk_level=mid</code></li>
<li>低危日志：<code>WHERE _pipeline.risk_level=low</code></li>
<li>多选（高危+中危）：<code>WHERE _pipeline.risk_level=high OR _pipeline.risk_level=mid</code></li>
</ol>
<h3 id='8aa0813814'>分页器</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>LIMIT 10</td>
</tr>
</tbody></table>

<ol>
<li>offset=0, pageSize=10：<code>LIMIT 10</code></li>
<li>offset=50, pageSize=10：<code>LIMIT 50, 10</code></li>
</ol>
<h3 id='50e7d28821'>危险日志相关日志</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>RELATED BY <event_id>, <label></td>
</tr>
</tbody></table>

<ol>
<li>指定危险日志event_id和危险类型标签：<code>RELATED BY event-d83h, 100</code></li>
<li>仅指定危险日志event_id（默认取labels第一个类型标签）：<code>RELATED BY event-d83h</code></li>
</ol>
<h3 id='e0457171b0'>过滤器叠加</h3>
<ol>
<li>不同过滤器的叠加由AND运算符实现；</li>
<li>当前OR运算不允许出现复合嵌套，例如（不合法实例！）：<code>WHERE (a=1 AND b=2) OR c=3</code>; </li>
<li>在以上基础上，当AND和OR同时出现，请在OR运算外部加括号表明优先级：<code>WHERE (a=1 OR b=2) AND c=3</code>;</li>
<li>BETWEEN语句在AND连用情况下，请在外部加括号表明优先级：<code>WHERE (range BETWEEN(low, high)) AND a=1</code>;
注意：2.3.4均属于语法设计不足，06-25后版本语法树会对此做进一步优化更新；</li>
</ol>

<p>实例：日志合法 + 日志类型=健康 + 部门=dept_1 + 时间区间 + 用户名/姓名%王 + 时间倒序 + 第二页:pagesize=10</p>

<p><code>WHERE _pipeline.is_valid=true AND _pipeline.risk_level=healthy AND _user.department_ids=dept_0 AND (time_local BETWEEN(2018-06-17T00:00:00+0800, 2018-07-01T00:00:00+0800)) AND (_user.username~王 OR _user.display_name~王) ORDER BY time_local DESC LIMIT 10, 10</code></p>
<h2 id='9ae4129295'>安全日志：更新接口</h2>
<p>接口调用方法见：<a href="#fe2cc3e076">基础CRUD-更新文档</a></p>
<pre class="highlight plaintext"><code>curl -X POST \
  'http://analytic_service:5000/api/update?type=log&amp;query=WHERE%20_pipeline.risk_level%3Dhealthy%20WHERE%20event_id%3Devent-d83h'
</code></pre>
<p>日志待更新字段：</p>

<ol>
<li>内部字段：实际存储在日志内部的字段，支持更新；</li>
<li>外部字段：实际存储在其他位置的字段，不支持更新！业务数据由专用接口完成更新；</li>
</ol>

<ul>
<li>内部字段</li>
</ul>

<table><thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>_external.status</td>
<td>keyword</td>
<td>日志处理状态=已处理(resolved)/未处理(unresolved)/忽略(ignored)，健康日志默认为空，危险日志默认为未处理</td>
</tr>
<tr>
<td>_external.resolved_method</td>
<td>keyword</td>
<td>日志已处理的手段=停用(suspend)/封禁(lock)；默认为空</td>
</tr>
<tr>
<td>_pipeline.risk_level</td>
<td>keyword</td>
<td>日志风险等级=high/mid/low/healthy(优先级高于label.xxx)</td>
</tr>
</tbody></table>
<h3 id='f9e9892904'>日志反馈（??是否联动日志处理状态？）</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>SET _pipeline.risk_level=healthy WHERE event_id=event-d83h</td>
</tr>
</tbody></table>

<ol>
<li>设置用户反馈=健康：<code>SET _pipeline.risk_level=healthy WHERE event_id=event-d83h</code></li>
<li>设置用户反馈=危险（危险程度=??）：<code>SET _pipeline.risk_level=high WHERE event_id=event-d83h</code></li>
</ol>
<h3 id='1558a0e6d8'>日志处理状态设置</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Example</th>
</tr>
</thead><tbody>
<tr>
<td>type</td>
<td>log</td>
</tr>
<tr>
<td>query</td>
<td>SET _external.status=resolved AND _external.resolved_method=lock WHERE event_id=event-d83h</td>
</tr>
</tbody></table>

<ol>
<li>设置处理状态=忽略：<code>SET _external.status=ignored WHERE event_id=event-d83h</code></li>
<li>设置处理状态=已处理：<code>SET _external.status=resolved AND _external.resolved_method=lock WHERE event_id=event-d83h</code></li>
<li>设置处理状态=未处理：<code>SET _external.status=unresolved WHERE event_id=event-d83h</code></li>
</ol>

<p>注意：日志处理方法仅对处理状态=已处理时有效；</p>
<h1 id='errors'>Errors</h1>
<aside class="notice">
This error section is stored in a separate file in <code>includes/_errors.md</code>. Slate allows you to optionally separate out your docs into many files...just save them to the <code>includes</code> folder and add them to the top of your <code>index.md</code>'s frontmatter. Files are included in the order listed.
</aside>

<p>The Kittn API uses the following error codes:</p>

<table><thead>
<tr>
<th>Error Code</th>
<th>Meaning</th>
</tr>
</thead><tbody>
<tr>
<td>400</td>
<td>Bad Request -- Your request is invalid.</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized -- Your API key is wrong.</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden -- The kitten requested is hidden for administrators only.</td>
</tr>
<tr>
<td>404</td>
<td>Not Found -- The specified kitten could not be found.</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed -- You tried to access a kitten with an invalid method.</td>
</tr>
<tr>
<td>406</td>
<td>Not Acceptable -- You requested a format that isn&#39;t json.</td>
</tr>
<tr>
<td>410</td>
<td>Gone -- The kitten requested has been removed from our servers.</td>
</tr>
<tr>
<td>418</td>
<td>I&#39;m a teapot.</td>
</tr>
<tr>
<td>429</td>
<td>Too Many Requests -- You&#39;re requesting too many kittens! Slow down!</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error -- We had a problem with our server. Try again later.</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable -- We&#39;re temporarily offline for maintenance. Please try again later.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">shell</a>
                <a href="#" data-language-name="ruby">ruby</a>
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
